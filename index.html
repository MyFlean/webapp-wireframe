<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dr. Meera Sharma × Flean</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --primary: #2D6A4F;
      --primary-dark: #1B4332;
      --error: #DC2626;
      --success: #16A34A;
      --bg: #FAFAFA;
      --card-bg: #FFFFFF;
      --text: #1F2937;
      --muted: #6B7280;
      --border: #E5E7EB;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 16px;
      line-height: 1.5;
      padding-bottom: 100px;
    }
    
    .container {
      max-width: 420px;
      margin: 0 auto;
      padding: 0 16px;
    }
    
    /* Header */
    header {
      text-align: center;
      padding: 24px 0 16px;
      border-bottom: 1px solid var(--border);
      background: var(--card-bg);
    }
    
    .logo {
      font-size: 28px;
      font-weight: 700;
      color: var(--primary);
      letter-spacing: -0.5px;
    }
    
    .tagline {
      font-size: 13px;
      color: var(--muted);
      margin-top: 4px;
    }
    
    /* Nutritionist Profile */
    .profile {
      background: var(--card-bg);
      padding: 20px 16px;
      margin-top: 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    
    .profile-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }
    
    .profile-subtitle {
      font-size: 14px;
      color: var(--primary);
      margin-top: 4px;
    }
    
    .profile-desc {
      font-size: 14px;
      color: var(--muted);
      margin-top: 12px;
      font-style: italic;
    }
    
    /* Section Titles */
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin: 24px 0 12px;
    }
    
    /* Dish Cards */
    .dish-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      border: 1px solid var(--border);
    }
    
    .dish-card-inner {
      display: flex;
      gap: 12px;
    }
    
    .dish-image {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      background: #E5E7EB;
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .dish-image.placeholder {
      background: linear-gradient(135deg, #E5E7EB, #F3F4F6);
    }
    
    .dish-main {
      flex: 1;
      min-width: 0;
    }
    
    .dish-name {
      font-size: 16px;
      font-weight: 600;
    }
    
    .dish-desc {
      font-size: 14px;
      color: var(--muted);
      margin-top: 4px;
    }
    
    .dish-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }
    
    .tag {
      font-size: 11px;
      font-weight: 500;
      padding: 4px 10px;
      border-radius: 20px;
      background: #ECFDF5;
      color: var(--primary);
    }
    
    .dish-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 14px;
      padding-top: 14px;
      border-top: 1px solid var(--border);
    }
    
    .dish-price {
      font-size: 16px;
      font-weight: 600;
      color: var(--primary);
    }
    
    .qty-control {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .qty-btn {
      width: 44px;
      height: 44px;
      border: 2px solid var(--border);
      background: var(--card-bg);
      border-radius: 8px;
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .qty-btn:active {
      background: var(--bg);
      transform: scale(0.95);
    }
    
    .qty-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .qty-value {
      width: 40px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
    }
    
    /* Form */
    .form-section {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 20px 16px;
      margin-top: 16px;
      border: 1px solid var(--border);
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-group:last-child {
      margin-bottom: 0;
    }
    
    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
    }
    
    .required::after {
      content: " *";
      color: var(--error);
    }
    
    input, textarea {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
      transition: border-color 0.15s;
    }
    
    input:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    input.error, textarea.error {
      border-color: var(--error);
    }
    
    .error-msg {
      font-size: 12px;
      color: var(--error);
      margin-top: 4px;
      display: none;
    }
    
    .error-msg.show {
      display: block;
    }
    
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    textarea.notes {
      min-height: 60px;
    }
    
    /* Sticky Footer */
    .footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      z-index: 100;
    }
    
    .footer-inner {
      max-width: 420px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
    }
    
    .summary-text {
      font-size: 14px;
      color: var(--muted);
    }
    
    .summary-text strong {
      color: var(--text);
      font-size: 16px;
    }
    
    .pay-btn {
      flex-shrink: 0;
      padding: 14px 28px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .pay-btn:hover:not(:disabled) {
      background: var(--primary-dark);
    }
    
    .pay-btn:active:not(:disabled) {
      transform: scale(0.98);
    }
    
    .pay-btn:disabled {
      background: var(--border);
      color: var(--muted);
      cursor: not-allowed;
    }
    
    .pay-btn.loading {
      pointer-events: none;
      opacity: 0.8;
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      padding: 14px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: white;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 200;
      max-width: 90%;
      text-align: center;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    .toast.success {
      background: var(--success);
    }
    
    .toast.error {
      background: var(--error);
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">Flean</div>
    <div class="tagline">Clean Kitchens. Healthy Execution.</div>
  </header>

  <main class="container">
    <section class="profile">
      <h1 class="profile-title">Dr. Meera Sharma × Flean</h1>
      <p class="profile-subtitle">Clinical Nutritionist · PCOS & Fat Loss Specialist</p>
      <p class="profile-desc">"These bowls are built from my clinically-tested protocols and prepared fresh in Flean's clean kitchen."</p>
    </section>

    <h2 class="section-title">Today's Clean Bowls</h2>
    
    <div id="dishes-container"></div>

    <section class="form-section">
      <h2 class="section-title" style="margin-top:0;">Your Details</h2>
      
      <div class="form-group">
        <label for="name" class="required">Full Name</label>
        <input type="text" id="name" placeholder="Enter your full name">
        <div class="error-msg" id="name-error">Please enter your name</div>
      </div>
      
      <div class="form-group">
        <label for="phone" class="required">Mobile Number</label>
        <input type="tel" id="phone" placeholder="10-digit mobile number" maxlength="10">
        <div class="error-msg" id="phone-error">Please enter a valid 10-digit number</div>
      </div>
      
      <div class="form-group">
        <label for="address" class="required">Flat / House No. & Society</label>
        <textarea id="address" placeholder="e.g., Flat 302, Tower B, Green Valley Society"></textarea>
        <div class="error-msg" id="address-error">Please enter your address</div>
      </div>
      
      <div class="form-group">
        <label for="notes">Notes (optional)</label>
        <textarea id="notes" class="notes" placeholder="e.g., No onions, extra spicy"></textarea>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      <div class="summary-text">
        <span id="item-count">0 items</span> · <strong>₹<span id="total-amount">0</span></strong>
      </div>
      <button class="pay-btn" id="pay-btn" disabled>Pay Now</button>
    </div>
  </footer>

  <div class="toast" id="toast"></div>

  <script>
    // ============================================
    // CONFIGURATION - UPDATE THESE URLS AFTER DEPLOYING APPS SCRIPTS
    // ============================================
    // Reads menu + profile data from the new "Flean Menus" spreadsheet
    const MENU_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzbeCiEuGiazMBVjK2ANRt8_g87zeVjIPqBsYpCZc_qhveIHJtzFvi6sM__wtxXo2I9tg/exec';
    // Writes orders into your existing orders spreadsheet (old Apps Script)
    const ORDER_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWYKj1P7_wsd74az_OxOFfsX3Acpk5SJHDGGEL-IUKt8eTyS7wnXr1vyyv5aBvZfo/exec';
    
    // --------------------------------------------
    // Resolve current nutritionist "slug" from URL
    // Supports:
    // - GitHub Pages project site:   /<repo>/<slug>
    // - User/org site or local dev: /<slug>
    // - Optional query param:       ?slug=meera
    // --------------------------------------------
    function getCurrentSlug() {
      try {
        const params = new URLSearchParams(window.location.search);
        const fromQuery = params.get('slug');
        if (fromQuery) {
          return fromQuery.toLowerCase();
        }
      } catch (e) {
        // ignore and fall back to path-based logic
      }

      const parts = window.location.pathname.split('/').filter(Boolean);

      // GitHub Pages project site: /<repo>/<slug>[/*]
      if (parts.length >= 2) {
        return parts[1].toLowerCase();
      }

      // User/org site or simple hosting: /<slug>
      if (parts.length === 1) {
        return parts[0].toLowerCase();
      }

      // Fallback default nutritionist slug
      return 'meera';
    }
    
    // ============================================
    // DISH DATA - LOADED FROM GOOGLE SHEETS
    // ============================================
    let dishes = [];

    // Track quantities
    let quantities = {};

    // Current nutritionist context (derived from URL + sheet)
    let CURRENT_NUTRITIONIST_SLUG = getCurrentSlug();
    let CURRENT_NUTRITIONIST_NAME = null;

    // Load menu from Google Sheets via Apps Script
    async function loadMenuFromSheet() {
      try {
        const url = `${MENU_SCRIPT_URL}?action=get_menu&slug=${encodeURIComponent(CURRENT_NUTRITIONIST_SLUG)}`;
        const res = await fetch(url);
        
        if (!res.ok) {
          throw new Error(`Menu fetch failed with status ${res.status}`);
        }
        
        const data = await res.json();

        if (data.error) {
          console.error('Menu API error:', data.error);
          showToast('Unable to load today’s bowls. Please refresh and try again.', 'error');
          return;
        }

        // Store canonical nutritionist name for orders
        CURRENT_NUTRITIONIST_NAME = data.nutritionist_name || CURRENT_NUTRITIONIST_SLUG;

        const sheetDishes = Array.isArray(data.dishes) ? data.dishes : [];
        
        dishes = sheetDishes.map((row, index) => {
          const rawTags = Array.isArray(row.tags)
            ? row.tags
            : (row.tags ? String(row.tags).split(',') : []);
          
          return {
            id: row.id || `dish_${index + 1}`,
            name: row.name || '',
            description: row.description || '',
            price: Number(row.price) || 0,
            tags: rawTags.map(t => String(t).trim()).filter(Boolean),
            image_url: row.image_url || ''
          };
        });

        // Reset quantities
        quantities = {};
        dishes.forEach(d => quantities[d.id] = 0);

        // Optional: allow profile copy to come from sheet config
        if (data.profile_title) {
          const el = document.querySelector('.profile-title');
          if (el) el.textContent = data.profile_title;
        }
        if (data.profile_subtitle) {
          const el = document.querySelector('.profile-subtitle');
          if (el) el.textContent = data.profile_subtitle;
        }
        if (data.profile_desc) {
          const el = document.querySelector('.profile-desc');
          if (el) el.textContent = data.profile_desc;
        }

        renderDishes();
        updateSummary();
      } catch (error) {
        console.error('Error loading menu from sheet:', error);
        showToast('Unable to load today’s bowls. Please refresh and try again.', 'error');
      }
    }

    // ============================================
    // RENDER DISHES
    // ============================================
    function renderDishes() {
      const container = document.getElementById('dishes-container');
      if (!dishes.length) {
        container.innerHTML = '<p style="font-size:14px; color: var(--muted);">No bowls are available right now. Please check back later.</p>';
        return;
      }

      container.innerHTML = dishes.map(dish => `
        <div class="dish-card">
          <div class="dish-card-inner">
            ${
              dish.image_url
                ? `<img src="${dish.image_url}" alt="${dish.name}" class="dish-image">`
                : `<div class="dish-image placeholder"></div>`
            }
            <div class="dish-main">
              <div class="dish-name">${dish.name}</div>
              <div class="dish-desc">${dish.description}</div>
              <div class="dish-tags">
                ${dish.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
              </div>
            </div>
          </div>
          <div class="dish-footer">
            <div class="dish-price">₹${dish.price} / bowl</div>
            <div class="qty-control">
              <button class="qty-btn" onclick="updateQty('${dish.id}', -1)" ${quantities[dish.id] === 0 ? 'disabled' : ''}>−</button>
              <span class="qty-value" id="qty-${dish.id}">${quantities[dish.id]}</span>
              <button class="qty-btn" onclick="updateQty('${dish.id}', 1)">+</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // ============================================
    // QUANTITY MANAGEMENT
    // ============================================
    function updateQty(id, delta) {
      const newQty = Math.max(0, quantities[id] + delta);
      quantities[id] = newQty;
      
      // Update display
      document.getElementById(`qty-${id}`).textContent = newQty;
      
      // Update minus button state
      const card = document.querySelector(`#qty-${id}`).closest('.dish-card');
      const minusBtn = card.querySelector('.qty-btn');
      minusBtn.disabled = newQty === 0;
      
      updateSummary();
    }

    function updateSummary() {
      let totalItems = 0;
      let totalAmount = 0;
      
      dishes.forEach(dish => {
        const qty = quantities[dish.id];
        totalItems += qty;
        totalAmount += qty * dish.price;
      });
      
      document.getElementById('item-count').textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
      document.getElementById('total-amount').textContent = totalAmount;
      
      updatePayButton();
    }

    // ============================================
    // FORM VALIDATION
    // ============================================
    function validateForm() {
      let isValid = true;
      
      // Name
      const name = document.getElementById('name').value.trim();
      if (!name) {
        showFieldError('name', true);
        isValid = false;
      } else {
        showFieldError('name', false);
      }
      
      // Phone
      const phone = document.getElementById('phone').value.trim();
      if (!/^\d{10}$/.test(phone)) {
        showFieldError('phone', true);
        isValid = false;
      } else {
        showFieldError('phone', false);
      }
      
      // Address
      const address = document.getElementById('address').value.trim();
      if (!address) {
        showFieldError('address', true);
        isValid = false;
      } else {
        showFieldError('address', false);
      }
      
      // At least one item
      const totalItems = Object.values(quantities).reduce((a, b) => a + b, 0);
      if (totalItems === 0) {
        isValid = false;
      }
      
      return isValid;
    }

    function showFieldError(fieldId, show) {
      const input = document.getElementById(fieldId);
      const error = document.getElementById(`${fieldId}-error`);
      
      if (show) {
        input.classList.add('error');
        error.classList.add('show');
      } else {
        input.classList.remove('error');
        error.classList.remove('show');
      }
    }

    function updatePayButton() {
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const totalItems = Object.values(quantities).reduce((a, b) => a + b, 0);
      
      const canPay = name && /^\d{10}$/.test(phone) && address && totalItems > 0;
      document.getElementById('pay-btn').disabled = !canPay;
    }

    // ============================================
    // PAYMENT SIMULATION
    // ============================================
    function simulatePayment() {
      return new Promise(resolve => {
        const delay = 800 + Math.random() * 400;
        setTimeout(() => resolve({ status: 'success' }), delay);
      });
    }

    // ============================================
    // ORDER SUBMISSION
    // ============================================
    async function handlePayment() {
      if (!validateForm()) {
        showToast('Please fill all required fields and select at least one bowl.', 'error');
        return;
      }
      
      const btn = document.getElementById('pay-btn');
      btn.textContent = 'Processing...';
      btn.classList.add('loading');
      btn.disabled = true;
      
      try {
        // Simulate payment
        await simulatePayment();
        
        // Build payload
        const orderId = 'FLEAN-' + Date.now();
        const items = [];
        let totalItems = 0;
        let totalAmount = 0;
        
        dishes.forEach(dish => {
          const qty = quantities[dish.id];
          if (qty > 0) {
            items.push({
              dish_id: dish.id,
              dish_name: dish.name,
              unit_price: dish.price,
              quantity: qty,
              line_total: qty * dish.price
            });
            totalItems += qty;
            totalAmount += qty * dish.price;
          }
        });
        
        const payload = {
          order_id: orderId,
          nutritionist_name: CURRENT_NUTRITIONIST_NAME || CURRENT_NUTRITIONIST_SLUG,
          source: 'web_mvp_v1',
          customer_name: document.getElementById('name').value.trim(),
          customer_phone: document.getElementById('phone').value.trim(),
          customer_address: document.getElementById('address').value.trim(),
          notes: document.getElementById('notes').value.trim(),
          items: items,
          total_items: totalItems,
          total_amount: totalAmount,
          payment_status: 'PAID_DUMMY',
          created_at: new Date().toISOString()
        };
        
        // Send order details to Google Sheets (orders script)
        const response = await fetch(ORDER_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          mode: 'no-cors' // Required for Apps Script
        });
        
        // With no-cors, we can't read response, so assume success
        showToast(`✅ Payment received! Order #${orderId} placed.`, 'success');
        resetForm();
        
      } catch (error) {
        console.error('Order error:', error);
        showToast('⚠️ Something went wrong. Please try again.', 'error');
      } finally {
        btn.textContent = 'Pay Now';
        btn.classList.remove('loading');
        updatePayButton();
      }
    }

    function resetForm() {
      // Reset quantities
      dishes.forEach(d => quantities[d.id] = 0);
      renderDishes();
      
      // Reset form fields
      document.getElementById('name').value = '';
      document.getElementById('phone').value = '';
      document.getElementById('address').value = '';
      document.getElementById('notes').value = '';
      
      // Clear errors
      ['name', 'phone', 'address'].forEach(f => showFieldError(f, false));
      
      updateSummary();
    }

    // ============================================
    // TOAST NOTIFICATIONS
    // ============================================
    function showToast(message, type) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    document.getElementById('pay-btn').addEventListener('click', handlePayment);
    
    // Real-time validation for pay button
    ['name', 'phone', 'address'].forEach(id => {
      document.getElementById(id).addEventListener('input', updatePayButton);
    });
    
    // Phone: numbers only
    document.getElementById('phone').addEventListener('input', function(e) {
      this.value = this.value.replace(/\D/g, '').slice(0, 10);
    });

    // ============================================
    // INITIALIZE
    // ============================================
    loadMenuFromSheet();
  </script>
</body>
</html>
